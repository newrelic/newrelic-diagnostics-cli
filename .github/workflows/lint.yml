name: golangci-lint
on:
  pull_request:
    paths-ignore:
      - 'README.md'
      - '*_test.go'
jobs:
  golangci:
    strategy:
      matrix:
        go-version: [1.22.x]
        os: [ubuntu-latest, macos-latest, windows-latest]
    name: lint
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Check for Cgo dependencies
        run: |
          echo "Searching for packages that require Cgo..."
          CGO_PACKAGES=$(go list -f '{{if .CgoFiles}}{{.ImportPath}}{{end}}' -tags cgo ./...)
          if [ -n "$CGO_PACKAGES" ]; then
            echo "::error::Found packages that require Cgo, which is not allowed."
            echo "This will result in a dynamically linked binary."
            echo "The following packages must be removed or refactored:"
            echo "$CGO_PACKAGES"
            # Exit with a non-zero status to fail the workflow
            exit 1
          else
            echo "Success: No Cgo dependencies found."
          fi

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.63
          args: --timeout=5m
          only-new-issues: true

